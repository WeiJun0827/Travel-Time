<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/main.css" />
</head>

<body>
    <div class="container">
        <div class="options-box">
            <div>
                <input id="search-place" type="text" placeholder="出發位置"">
                <input id=" search-time" type="number" value="30" min="5" max="90" step="5">
                <input id="search-btn" type="button" value="Go">
                <hr>
                <div id="lat"></div>
                <div id="lon"></div>
                <input id="my-position-btn" type="button" value="我的位置">
            </div>
        </div>
        <div id="map"></div>
    </div>
    <!-- <script src="./js/main.js"></script> -->
    <script>
        let map;
        let marker;

        function initMap() {
            // Constructor creates a new map - only center and zoom are required.
            const mapOptions = {
                center: new google.maps.LatLng(25.0478072, 121.5170185),
                zoom: 13,
                mapTypeControl: false
            }
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            initMarker(mapOptions.center);
            map.setCenter(mapOptions.center);

            const searchBox = new google.maps.places.SearchBox(
                document.getElementById('search-place'));
            searchBox.setBounds(map.getBounds());
            searchBox.addListener('places_changed', function () {
                searchBoxPlaces(this);
            });

            document.getElementById('search-btn').addEventListener('click', textSearchPlaces);
            document.getElementById('my-position-btn').addEventListener('click', goToUsersLocation);

            drawPolygon();
        }

        function initMarker(position) {
            const icon = {
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 5,
                strokeColor: '#CC2222'
            };
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({
                map: map,
                position: position,
                title: '旅程起點',
                draggable: true,
                icon: icon
            });
            updateLatLon();
            //gets the new latlong if the marker is dragged		  
            google.maps.event.addListener(marker, "drag", function () {
                updateLatLon();
            });
        }


        function goToUsersLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const currentPosition = new google.maps.LatLng(
                        position.coords.latitude,
                        position.coords.longitude);
                    // moveMarkerForPlace(currentPosition);

                    marker.setPosition(currentPosition);
                    map.setCenter(currentPosition);
                    updateLatLon();
                })
            }
        }

        function updateLatLon() {
            document.getElementById("lat").innerHTML = marker.getPosition().lat();
            document.getElementById("lon").innerHTML = marker.getPosition().lng();
        }

        function searchBoxPlaces(searchBox) {
            // hideMarkers(placeMarkers);
            var places = searchBox.getPlaces();
            if (places.length == 0) {
                window.alert('沒有符合的搜尋結果');
            } else {
                moveMarkerForPlace(places[0]);
            }
        }

        function textSearchPlaces() {
            var bounds = map.getBounds();
            // hideMarkers(placeMarkers);
            var placesService = new google.maps.places.PlacesService(map);
            placesService.textSearch({
                query: document.getElementById('search-place').value,
                bounds: bounds
            }, function (results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    // createMarkersForPlaces(results);
                    moveMarkerForPlace(results[0]);
                }
            });
        }

        function moveMarkerForPlace(place) {
            const bounds = new google.maps.LatLngBounds();
            marker.setPosition(place.geometry.location);
            if (place.geometry.viewport) {
                // Only geocodes have viewport.
                bounds.union(place.geometry.viewport);
            } else {
                bounds.extend(place.geometry.location);
            }
            map.fitBounds(bounds);
            updateLatLon();
        }

        function drawPolygon() {
            var bigOne = new google.maps.LatLng(25.041135, 121.565685);
            var smallOne = new google.maps.LatLng(25.041370, 121.557815);
            var anotherOne = new google.maps.LatLng(25.040855, 121.5762);

            const joined = new google.maps.Polygon({
                paths: [drawCircle(smallOne, 350, 1),
                drawCircle(bigOne, 500, 1),
                drawCircle(anotherOne, 250, 1)],
                strokeColor: "#ff0000",
                strokeOpacity: 0.35,
                strokeWeight: 0,
                fillColor: "#FF0000",
                fillOpacity: 0.35
            });
            joined.setMap(map)
        }

        function drawCircle(point, radius, dir) {
            var d2r = Math.PI / 180; // degrees to radians 
            var r2d = 180 / Math.PI; // radians to degrees 
            var earthsradius = 6371e3; // the radius of the earth in metre
            var points = 32;

            // find the raidus in lat/lon 
            var rlat = (radius / earthsradius) * r2d;
            var rlng = rlat / Math.cos(point.lat() * d2r);

            var extp = [];
            if (dir == 1) {
                var start = 0;
                var end = points + 1
            } // one extra here makes sure we connect the
            else {
                var start = points + 1;
                var end = 0
            }
            for (var i = start;
                (dir == 1 ? i < end : i > end); i = i + dir) {
                var theta = Math.PI * (i / (points / 2));
                ey = point.lng() + (rlng * Math.cos(theta)); // center a + radius x * cos(theta) 
                ex = point.lat() + (rlat * Math.sin(theta)); // center b + radius y * sin(theta) 
                extp.push(new google.maps.LatLng(ex, ey));
            }
            return extp;
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?libraries=places,geometry,drawing&key=AIzaSyBFFH-k40TGQI-ktrgnvGTlcNbCHm6JOkY&v=3&callback=initMap"></script>
</body>

</html>